@page
@model RegisterModel
@{
    ViewData["Title"] = "Register";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="text-center mb-4">
            <i class="fas fa-user-plus fa-3x mb-3" style="color: #333333;"></i>
            <h2>Create Account</h2>
            <p class="text-muted">Join TurbineAero and start managing your turbines today.</p>
        </div>

        <form id="registerForm" method="post">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Input.FirstName" class="form-label">First Name</label>
                    <input asp-for="Input.FirstName" class="form-control" autocomplete="given-name" />
                    <span asp-validation-for="Input.FirstName" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Input.LastName" class="form-label">Last Name</label>
                    <input asp-for="Input.LastName" class="form-control" autocomplete="family-name" />
                    <span asp-validation-for="Input.LastName" class="text-danger"></span>
                </div>
            </div>
            
            <div class="mb-3">
                <label asp-for="Input.Email" class="form-label">Email</label>
                <input asp-for="Input.Email" class="form-control" autocomplete="email" />
                <span asp-validation-for="Input.Email" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
                <label asp-for="Input.Phone" class="form-label">Phone Number</label>
                <input asp-for="Input.Phone" class="form-control" autocomplete="tel" />
                <span asp-validation-for="Input.Phone" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
                <label asp-for="Input.Password" class="form-label">Password</label>
                <input asp-for="Input.Password" class="form-control" autocomplete="new-password" />
                <span asp-validation-for="Input.Password" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
                <label asp-for="Input.ConfirmPassword" class="form-label">Confirm Password</label>
                <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" />
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
            </div>
            
            <div class="d-grid">
                <button id="register-submit" type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-user-plus me-2"></i>Create Account
                </button>
            </div>
        </form>

        <div class="text-center mt-4">
            <p>
                Already have an account? <a asp-page="./Login" asp-route-returnUrl="@Model.ReturnUrl">Sign in here</a>
            </p>
        </div>
    </div>
</div>

<!-- OTP Verification Modal -->
<div class="modal fade" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="otpModalLabel">
                    <i class="fas fa-shield-alt me-2" style="color: #333333;"></i>Verify Your Account
                </h5>
            </div>
            <div class="modal-body">
                <p class="text-muted">We've sent verification codes to your email and phone number. Please enter both codes below.</p>
                
                <form id="otpForm">
                    <div class="mb-3">
                        <label for="emailOtp" class="form-label">Email Verification Code</label>
                        <input type="text" id="emailOtp" class="form-control text-center" maxlength="6" placeholder="000000" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="phoneOtp" class="form-label">Phone Verification Code</label>
                        <input type="text" id="phoneOtp" class="form-control text-center" maxlength="6" placeholder="000000" />
                    </div>
                    
                    <div class="text-center">
                        <button type="button" id="resendOtpBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i>Resend Codes
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="verifyOtpBtn" class="btn btn-primary">
                    <i class="fas fa-check me-2"></i>Verify & Complete Registration
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let userEmail = '';
        let userPhone = '';

        // Handle registration form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            // Map Razor input names (Input.*) to API DTO property names
            const data = {
                firstName: formData.get('Input.FirstName'),
                lastName: formData.get('Input.LastName'),
                email: formData.get('Input.Email'),
                phone: formData.get('Input.Phone'),
                password: formData.get('Input.Password'),
                confirmPassword: formData.get('Input.ConfirmPassword')
            };
            
            try {
                const response = await fetch('https://localhost:7003/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });
                
                const result = await response.json();

                if (result.success) {
                    userEmail = data.email;
                    userPhone = data.phone;
                    showToast('Registration successful! Please verify your email and phone number.', 'success');
                    $('#otpModal').modal('show');
                } else {
                    let details = '';
                    if (Array.isArray(result.errors) && result.errors.length) {
                        details = `: ${result.errors.join(', ')}`;
                    } else if (result.errors && typeof result.errors === 'object') {
                        const flat = Object.values(result.errors).flat();
                        if (flat.length) details = `: ${flat.join(', ')}`;
                    }
                    showToast((result.message || 'Registration failed') + details, 'error');
                }
            } catch (error) {
                showToast('An error occurred during registration', 'error');
            }
        });

        // Handle OTP verification
        document.getElementById('verifyOtpBtn').addEventListener('click', async function() {
            const emailOtp = document.getElementById('emailOtp').value;
            const phoneOtp = document.getElementById('phoneOtp').value;
            
            if (!emailOtp || !phoneOtp) {
                showToast('Please enter both verification codes', 'error');
                return;
            }
            
            try {
                const response = await fetch('https://localhost:7003/api/auth/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: userEmail,
                        emailOtp: emailOtp,
                        phoneOtp: phoneOtp
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Account verified successfully! You can now sign in.', 'success');
                    $('#otpModal').modal('hide');
                    window.location.href = '/Account/Login';
                } else {
                    showToast(result.message || 'Verification failed', 'error');
                }
            } catch (error) {
                showToast('An error occurred during verification', 'error');
            }
        });

        // Handle resend OTP
        document.getElementById('resendOtpBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('https://localhost:7003/api/auth/resend-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: userEmail
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Verification codes sent successfully', 'success');
                } else {
                    showToast(result.message || 'Failed to resend codes', 'error');
                }
            } catch (error) {
                showToast('An error occurred while resending codes', 'error');
            }
        });
    </script>
}
