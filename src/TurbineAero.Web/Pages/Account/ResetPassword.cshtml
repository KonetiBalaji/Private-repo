@page
@model ResetPasswordModel
@{
    ViewData["Title"] = "Reset Password";
}

<style>
    .reset-container {
        display: flex;
        justify-content: center;
        padding: 96px 16px;
    }

    .reset-card {
        width: 500px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        border: none;
        overflow: hidden;
    }

    .reset-card-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #dadde1;
    }

    .reset-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #1c1e21;
    }

    .reset-text {
        color: #606770;
        margin: 0;
    }

    .reset-card-body {
        padding: 20px 24px 24px;
    }

    .reset-input {
        height: 52px;
        border-radius: 6px;
        border-color: #dddfe2;
        font-size: 1rem;
    }

    .reset-input:focus {
        border-color: #1877f2;
        box-shadow: none;
    }

    .btn-reset {
        background-color: #1877f2;
        border-color: #1877f2;
        color: #ffffff;
        font-weight: 600;
        min-width: 120px;
        width: 100%;
    }

    .btn-reset:hover {
        background-color: #1366d1;
        border-color: #1366d1;
    }

    .btn-cancel {
        background-color: #e4e6eb;
        border-color: #e4e6eb;
        color: #050505;
        font-weight: 600;
        min-width: 120px;
    }

    .btn-cancel:hover {
        background-color: #d8dadf;
        border-color: #d8dadf;
        color: #050505;
    }

    .password-guidelines {
        border: 1px solid #dadde1;
        border-radius: 8px;
        background: #ffffff;
        padding: 12px 16px;
        margin-top: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: all 0.25s ease;
    }

    .password-guidelines.guideline-success {
        border-color: #31a24c;
        background: #e8f5ed;
        box-shadow: 0 6px 18px rgba(49, 162, 76, 0.25);
    }

    .password-guidelines .rule {
        font-size: 0.92rem;
        margin-bottom: 6px;
        transition: color 0.3s ease;
    }

    .password-guidelines .rule:last-child {
        margin-bottom: 0;
    }
</style>

<div class="reset-container">
    <div class="reset-card">
        <div class="reset-card-header">
            <h2 class="reset-title">Reset Password</h2>
            <p class="reset-text">Enter your new password below.</p>
        </div>
        <div class="reset-card-body">
            <form id="resetPasswordForm" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <input type="hidden" id="token" value="@Request.Query["token"]" />
                <input type="hidden" id="email" value="@Request.Query["email"]" />

                <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" id="newPassword" name="NewPassword" class="form-control reset-input" placeholder="Enter new password" autocomplete="new-password" required />
                    <div id="passwordGuidelines" class="password-guidelines d-none">
                        <div id="ruleLength" class="rule text-danger">• Must be 8-12 characters long</div>
                        <div id="ruleLetters" class="rule text-danger">• Must include letters</div>
                        <div id="ruleNumbers" class="rule text-danger">• Must include numbers</div>
                        <div id="ruleSpecial" class="rule text-danger">• Must include special characters</div>
                    </div>
                    <span asp-validation-for="Input.NewPassword" class="text-danger small d-block"></span>
                </div>

                <div class="mb-4">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="ConfirmPassword" class="form-control reset-input" placeholder="Confirm new password" autocomplete="new-password" required />
                    <small id="confirmHint" class="form-text small d-none"></small>
                    <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a href="/Account/Login" class="btn btn-cancel">Cancel</a>
                    <button type="submit" class="btn btn-reset" id="resetSubmitBtn" disabled>Reset Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Get form elements
        const passwordInput = document.getElementById('newPassword');
        const confirmInput = document.getElementById('confirmPassword');
        const confirmHint = document.getElementById('confirmHint');
        const guidelinesBox = document.getElementById('passwordGuidelines');
        const ruleLength = document.getElementById('ruleLength');
        const ruleLetters = document.getElementById('ruleLetters');
        const ruleNumbers = document.getElementById('ruleNumbers');
        const ruleSpecial = document.getElementById('ruleSpecial');
        const resetForm = document.getElementById('resetPasswordForm');
        const resetBtn = document.getElementById('resetSubmitBtn');

        // Regex patterns (same as registration)
        const letterRegex = /[A-Za-z]/;
        const numberRegex = /\d/;
        const specialRegex = /[^A-Za-z0-9]/;

        // State variables
        let guidelineHideTimeout;
        let confirmHideTimeout;
        let passwordValid = false;
        let confirmValid = false;

        // Set rule state (red/green)
        const setRuleState = (element, satisfied) => {
            element.classList.toggle('text-success', satisfied);
            element.classList.toggle('text-danger', !satisfied);
        };

        // Hide password guidelines
        const hideGuidelines = (resetRules = false) => {
            guidelinesBox.classList.add('d-none');
            guidelinesBox.classList.remove('guideline-success');
            if (resetRules) {
                [ruleLength, ruleLetters, ruleNumbers, ruleSpecial].forEach(rule => {
                    rule.classList.remove('text-success');
                    rule.classList.add('text-danger');
                });
            }
        };

        // Update password guidelines
        const updatePasswordGuidelines = () => {
            const value = passwordInput.value;
            clearTimeout(guidelineHideTimeout);

            if (!value) {
                hideGuidelines(true);
                passwordValid = false;
                updateSubmitState();
                return false;
            }

            const hasLength = value.length >= 8 && value.length <= 12;
            const hasLetters = letterRegex.test(value);
            const hasNumbers = numberRegex.test(value);
            const hasSpecial = specialRegex.test(value);

            setRuleState(ruleLength, hasLength);
            setRuleState(ruleLetters, hasLetters);
            setRuleState(ruleNumbers, hasNumbers);
            setRuleState(ruleSpecial, hasSpecial);

            passwordValid = hasLength && hasLetters && hasNumbers && hasSpecial;

            guidelinesBox.classList.remove('d-none');

            if (passwordValid) {
                guidelinesBox.classList.add('guideline-success');
                guidelineHideTimeout = setTimeout(() => {
                    hideGuidelines();
                }, 900);
            } else {
                guidelinesBox.classList.remove('guideline-success');
            }

            if (confirmInput.value) {
                updateConfirmHint();
            }

            updateSubmitState();
            return passwordValid;
        };

        // Update confirm password hint
        const updateConfirmHint = () => {
            clearTimeout(confirmHideTimeout);

            const password = passwordInput.value;
            const confirm = confirmInput.value;

            if (!confirm) {
                confirmHint.textContent = '';
                confirmHint.classList.remove('text-success', 'text-danger');
                confirmHint.classList.add('d-none');
                confirmValid = false;
                updateSubmitState();
                return false;
            }

            confirmValid = password && confirm === password;
            confirmHint.textContent = confirmValid ? 'Passwords match.' : 'Passwords do not match.';
            confirmHint.classList.toggle('text-success', confirmValid);
            confirmHint.classList.toggle('text-danger', !confirmValid);
            confirmHint.classList.remove('d-none');

            if (confirmValid) {
                confirmHideTimeout = setTimeout(() => {
                    confirmHint.classList.add('d-none');
                    confirmHint.classList.remove('text-success', 'text-danger');
                }, 900);
            }

            updateSubmitState();
            return confirmValid;
        };

        // Update submit button state
        const updateSubmitState = () => {
            resetBtn.disabled = !(passwordValid && confirmValid);
        };

        // Initialize submit button state
        updateSubmitState();

        // Event listeners for real-time validation
        passwordInput.addEventListener('input', updatePasswordGuidelines);
        passwordInput.addEventListener('focus', () => {
            if (passwordInput.value) {
                updatePasswordGuidelines();
            } else {
                guidelinesBox.classList.remove('d-none');
            }
        });
        passwordInput.addEventListener('blur', () => {
            if (!passwordInput.value) {
                hideGuidelines(true);
            }
        });
        confirmInput.addEventListener('input', updateConfirmHint);

        // Form submission
        resetForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const token = document.getElementById('token').value;
            const email = document.getElementById('email').value;
            const newPassword = passwordInput.value;
            const confirmPassword = confirmInput.value;

            // Validate token and email are present
            if (!token || !email) {
                showToast('Invalid reset link. Please request a new password reset.', 'error');
                return;
            }

            // Validate password rules
            if (!passwordValid) {
                showToast('Please ensure your password meets all requirements', 'error');
                updatePasswordGuidelines();
                return;
            }

            // Validate passwords match
            if (!confirmValid) {
                showToast('Passwords do not match', 'error');
                updateConfirmHint();
                return;
            }

            const data = {
                Token: token,
                Email: email,
                NewPassword: newPassword,
                ConfirmPassword: confirmPassword
            };

            try {
                const response = await fetch('https://localhost:7003/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('Failed to parse response:', parseError);
                    showToast('Invalid response from server', 'error');
                    return;
                }

                if (response.ok && result.success) {
                    showToast('Password reset successful! Redirecting to login...', 'success');
                    setTimeout(() => {
                        window.location.href = '/Account/Login';
                    }, 1500);
                } else {
                    // Show detailed error message
                    const errorMsg = result.message || result.errors?.join(', ') || 'Failed to reset password';
                    showToast(errorMsg, 'error');
                    console.error('API Error:', result);
                }
            } catch (error) {
                console.error('Error:', error);
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showToast('Cannot connect to API server. Please make sure the API service is running on https://localhost:7003', 'error');
                } else {
                    showToast('An error occurred while processing your request', 'error');
                }
            }
        });
    </script>
}

