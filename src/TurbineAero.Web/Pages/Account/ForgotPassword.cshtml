@page
@model ForgotPasswordModel
@{
    ViewData["Title"] = "Find your account";
}

<style>
    .forgot-container {
        display: flex;
        justify-content: center;
        padding: 96px 16px;
    }

    .forgot-card {
        width: 500px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        border: none;
        overflow: hidden;
    }

    .forgot-card-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #dadde1;
    }

    .forgot-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #1c1e21;
    }

    .forgot-text {
        color: #606770;
        margin: 0;
    }

    .forgot-card-body {
        padding: 20px 24px 24px;
    }

    .forgot-input {
        height: 52px;
        border-radius: 6px;
        border-color: #dddfe2;
        font-size: 1rem;
    }

    .forgot-input:focus {
        border-color: #1877f2;
        box-shadow: none;
    }

    .btn-search {
        background-color: #1877f2;
        border-color: #1877f2;
        color: #ffffff;
        font-weight: 600;
        min-width: 120px;
    }

    .btn-search:hover {
        background-color: #1366d1;
        border-color: #1366d1;
    }

    .btn-cancel {
        background-color: #e4e6eb;
        border-color: #e4e6eb;
        color: #050505;
        font-weight: 600;
        min-width: 120px;
    }

    .btn-cancel:hover {
        background-color: #d8dadf;
        border-color: #d8dadf;
        color: #050505;
    }
</style>

<div class="forgot-container">
    <div class="forgot-card">
        <div class="forgot-card-header">
            <h2 class="forgot-title">Find your account</h2>
            <p class="forgot-text">Please enter your email to search for your account.</p>
        </div>
        <div class="forgot-card-body">
            <form id="forgotPasswordForm" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="mb-4">
                    <input asp-for="Input.Email" class="form-control forgot-input" placeholder="Email" autocomplete="email" />
                    <span asp-validation-for="Input.Email" class="text-danger small"></span>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a href="/" class="btn btn-cancel">Cancel</a>
                    <button type="submit" class="btn btn-search">Search</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById('forgotPasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const email = formData.get('Input.Email') || formData.get('Email') || '';
            
            // Validate email on client side
            if (!email || email.indexOf('@@') === -1) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            // Prepare data for API (API expects "Email" not "Input.Email")
            const data = {
                Email: email
            };

            try {
                const response = await fetch('https://localhost:7003/api/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                // Check if response is ok before trying to parse JSON
                if (!response.ok && response.status === 0) {
                    showToast('Cannot connect to API server. Please make sure the API service is running on https://localhost:7003', 'error');
                    return;
                }

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('Failed to parse response:', parseError);
                    showToast('Invalid response from server', 'error');
                    return;
                }

                if (response.ok && result.success) {
                    showToast('If the email exists, a password reset link has been sent.', 'success');
                    // Clear the form
                    document.getElementById('forgotPasswordForm').reset();
                } else {
                    // Show detailed error message
                    const errorMsg = result.message || result.errors?.join(', ') || 'Failed to send reset link';
                    showToast(errorMsg, 'error');
                    console.error('API Error:', result);
                }
            } catch (error) {
                console.error('Error:', error);
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showToast('Cannot connect to API server. Please make sure the API service is running on https://localhost:7003', 'error');
                } else {
                    showToast('An error occurred while processing your request', 'error');
                }
            }
        });
    </script>
}
